---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---
<!--
Copyright 2018 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->


# Retail trade


This set of scripts creates summary tables and graphs plotting the monthly Retail Trade data collected and reported by Statistics Canada.

#### packages

```{r}

# tidyverse
library(tidyverse)
#library(readr)
#library(ggplot2) 
#library(dplyr)
library(stringr)
library(glue)

# monthly data series
library(lubridate)
# extending ggplot2
library("scales")

# cansim
#install.packages("devtools")
#devtools::install_github("mountainmath/cansim")
library(cansim)

```

---

## Background

The Daily, 2019-10-22

* https://www150.statcan.gc.ca/n1/daily-quotidien/191022/dq191022a-eng.htm

The Daily, 2019-02-22

* https://www150.statcan.gc.ca/n1/daily-quotidien/190222/dq190222a-eng.htm?HPA=1


The Daily, 2018-09-21

* https://www150.statcan.gc.ca/n1/daily-quotidien/180921/dq180921b-eng.htm



## data

There are 3 data tables associated with this:
https://www150.statcan.gc.ca/n1/daily-quotidien/180921/dq180921b-cansim-eng.htm


The primary one is the first below:

* Retail trade sales by province and territory (x 1,000)

  - Table: 20-10-0008-01 (formerly CANSIM  080-0020)
  
  - https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=2010000801

* Retail E-commerce sales, unadjusted (x 1,000)

  - Table: 20-10-0072-01 (formerly CANSIM  080-0033)

  - https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=2010007201
  
* Retail sales, price, and volume, seasonally adjusted (x 1,000,000): Constant Prices

  - Table: 20-10-0078-01 (formerly CANSIM  080-0027)

  - https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=2010007801
  


###

Read the data


```{r}

data_20_10_0008 <- get_cansim("20-10-0008-01")

data_20_10_0008 <- data_20_10_0008 %>%
    mutate(REF_DATE = ymd(REF_DATE, truncated = 2)) 
  

data_20_10_0078 <- get_cansim("20-10-0078-01")

data_20_10_0078 <- data_20_10_0078 %>%
    mutate(REF_DATE = ymd(REF_DATE, truncated = 2)) 
  
```



try some filtering

```{r}

filenamenum <- "data_20_10_0008"

print(glue("TABLE:  ", filenamenum))

ls.str(data_20_10_0008)

latest_month <- as_date(max(data_20_10_0008$REF_DATE))

last_month <- latest_month - months(1)
last_year <- latest_month - years(1)

data_20_10_0008 %>%
  filter(
#    GEO == "British Columbia",
    `Adjustments` %in% c("Unadjusted", "Seasonally adjusted"),
    `Classification Code for North American Industry Classification System (NAICS)` == "[44-45]") %>%
  group_by(GEO, `Adjustments`) %>%
  mutate(MOM_val = lag(VALUE),
         MOM_pct = ((VALUE / lag(VALUE, n = 1)) - 1) * 100,
         MOM_chg = (VALUE - lag(VALUE, n = 1)) ) %>%
  mutate(YOY_val = lag(VALUE, n = 12),
         YOY_pct = ((VALUE / lag(VALUE, n = 12)) - 1) * 100,
         YOY_chg = (VALUE - lag(VALUE, n = 12)) ) %>%
  arrange(desc(REF_DATE)) %>%
  select(REF_DATE, GEO,
         Adjustments,
         VALUE, 
         MOM_val, MOM_pct, MOM_chg,
         YOY_val, YOY_pct, YOY_chg) %>%
  ungroup() %>%
#  filter(REF_DATE >= "2017-07-01", 
  filter(REF_DATE %in% c(as.Date(latest_month)
#                         , 
#                         as.Date("2018-11-01"), as.Date("2017-12-01")
                         ), 
         `Adjustments` == "Seasonally adjusted") %>%
  arrange(MOM_pct)


unique(data_20_10_0008$GEO)

data_Can_BC_YVR <- data_20_10_0008 %>%
  filter(GEO %in% c("Canada", "British Columbia", "Vancouver, British Columbia"), 
    `Adjustments` %in% c("Unadjusted", "Seasonally adjusted") ) %>%
  group_by(GEO, 
           `Adjustments`,
           `Classification Code for North American Industry Classification System (NAICS)`) %>%
  mutate(MOM_val = lag(VALUE),
         MOM_pct = ((VALUE / lag(VALUE, n = 1)) - 1) * 100,
         MOM_chg = (VALUE - lag(VALUE, n = 1)) ) %>%
  mutate(YOY_val = lag(VALUE, n = 12),
         YOY_pct = ((VALUE / lag(VALUE, n = 12)) - 1) * 100,
         YOY_chg = (VALUE - lag(VALUE, n = 12)) ) %>%
  arrange(desc(REF_DATE)) %>%
  select(REF_DATE, GEO,
         `Classification Code for North American Industry Classification System (NAICS)`,        
         Adjustments,
         VALUE, 
         MOM_val, MOM_pct, MOM_chg,
         YOY_val, YOY_pct, YOY_chg) %>%
  ungroup() 

data_Can_BC_YVR

data_Can_BC_YVR %>%
  filter(REF_DATE %in% c(latest_month, last_month, last_year),
#  filter(REF_DATE %in% c(as.Date("2018-07-01", "2018-06-01", "2017-07-01")),
         GEO == "Canada",
         `Classification Code for North American Industry Classification System (NAICS)` == "[44-45]",
         `Adjustments` == "Seasonally adjusted")


write_csv(data_Can_BC_YVR, "data_Can_BC_YVR.csv")


```




```{r}


BC_data_0008 <- 
 data_20_10_0008 %>%
  filter(GEO == "British Columbia",
    `Adjustments` %in% c("Unadjusted", "Seasonally adjusted") ) %>%
  group_by(GEO, `Adjustments`,
           `Classification Code for North American Industry Classification System (NAICS)`) %>%
  mutate(MOM_val = lag(VALUE),
         MOM_pct = ((VALUE / lag(VALUE, n = 1)) - 1) * 100,
         MOM_chg = (VALUE - lag(VALUE, n = 1)) ) %>%
  mutate(YOY_val = lag(VALUE, n = 12),
         YOY_pct = ((VALUE / lag(VALUE, n = 12)) - 1) * 100,
         YOY_chg = (VALUE - lag(VALUE, n = 12)) ) %>%
  arrange(VECTOR, REF_DATE) %>%
  ungroup()

BC_data_0008

BC_data_0008 %>%
  filter(
    REF_DATE == "2018-12-01",
         `Classification Code for North American Industry Classification System (NAICS)` 
         == "[44-45]") %>%
  select(REF_DATE, GEO, 
         `North American Industry Classification System (NAICS)`,
         Adjustments, VALUE,
         MOM_val, MOM_pct) %>%
  mutate(MOM_netchange = VALUE - MOM_val) %>%
  arrange(MOM_netchange)


# Year over year, major retail groups (3 digit NAICS)
BC_data_0008 %>%
  filter(
    REF_DATE == "2018-12-01",
    str_detect(
      `Classification Code for North American Industry Classification System (NAICS)`, "\\[4..\\]")
    ) %>%
    select(REF_DATE, GEO, 
         `North American Industry Classification System (NAICS)`,
         `Classification Code for North American Industry Classification System (NAICS)`, 
         Adjustments, VALUE,
#         MOM_val, MOM_pct, 
         YOY_val, YOY_pct) %>%
  mutate(YOY_netchange = VALUE - YOY_val) %>%
  arrange(YOY_netchange)

write_csv(BC_data_0008, "BC_data_0008.csv")

```



