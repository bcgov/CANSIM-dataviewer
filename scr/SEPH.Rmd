---
title: "SEPH"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---
<!--
Copyright 2018 Province of British Columbia

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and limitations under the License.
-->


# Survey of Employment, Payrolls and Hours


This set of scripts creates summary tables and graphs plotting the monthly SEPH data collected and reported by Statistics Canada.

#### packages

```{r}

# tidyverse
library(tidyverse)
#library(readr)
#library(ggplot2) 
#library(dplyr)
library(stringr)
library(glue)

# monthly data series
library(lubridate)
# extending ggplot2
library("scales")

# cansim
#install.packages("devtools")
#devtools::install_github("mountainmath/cansim")
library(cansim)

```

---

## Background

The Daily, 2018-10-25

* https://www150.statcan.gc.ca/n1/daily-quotidien/181025/dq181025a-eng.htm


**Important:** "In general, changes in weekly earnings reflect a number of factors, including wage growth; changes in the composition of employment by industry, occupation and level of job experience; and average hours worked per week."



## data

There are multiple (13) data tables associated with the SEPH:
https://www150.statcan.gc.ca/n1/daily-quotidien/181025/dq181025a-cansim-eng.htm

The principal tables used here are:

* Employment and average weekly earnings (including overtime) for all employees by province and territory, monthly, seasonally adjusted

  - Table: 14-10-0223-01 (formerly CANSIM  281-0063)
  
  - https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1410022301


* Average weekly hours for employees paid by the hour, by industry, monthly, unadjusted for seasonality

  - Table: 14-10-0255-01 (formerly CANSIM  281-0032)

  - https://www150.statcan.gc.ca/t1/tbl1/en/tv.action?pid=1410025501
  


### Read the data


**NOTE:**

This script uses the [R package `cansim`](https://github.com/mountainMath/cansim)


```{r}

data_14_10_0223_01 <- get_cansim("14-10-0223-01")

data_14_10_0223_01 <- data_14_10_0223_01 %>%
    mutate(REF_DATE = ymd(REF_DATE, truncated = 2)) 
  

```


#### understanding the data 

```{r}

filenamenum <- "data_14_10_0223_01"

print(glue("TABLE:  ", filenamenum))

ls.str(data_14_10_0223_01)

print("----")
print("values of Estimate")
unique(data_14_10_0223_01$Estimate)

print("----")
print("values of NAICS")
unique(data_14_10_0223_01$`North American Industry Classification System (NAICS)`)

```


```{r}
data_14_10_0223_01 %>%
  filter(GEO == "Canada",
         Estimate == "Employment for all employees") %>%
  filter(REF_DATE == "2018-07-01")

data_14_10_0223_01 %>%
  filter(GEO == "British Columbia",
         Estimate == "Employment for all employees") %>%
  filter(REF_DATE == "2018-07-01")


```


#### vector numbers

Industrial aggregate including unclassified businesses	- Canada: v79310773 / BC: v79311043

Goods producing industries	- Canada: v79310775 / BC: v79311045

Service producing industries	- Canada: v79310785 / BC: v79311055


```{r}


data_14_10_0223_01 %>%
  filter(GEO %in% c("British Columbia", "Canada"), 
    `Classification Code for North American Industry Classification System (NAICS)` == "[00-91N]") %>%
  group_by(GEO) %>%
  mutate(MOM_val = lag(VALUE),
         MOM_pct = ((VALUE / lag(VALUE, n = 1)) - 1) * 100,
         MOM_chg = (VALUE - lag(VALUE, n = 1)) ) %>%
  mutate(YOY_val = lag(VALUE, n = 12),
         YOY_pct = ((VALUE / lag(VALUE, n = 12)) - 1) * 100,
         YOY_chg = (VALUE - lag(VALUE, n = 12)) ) %>%
  arrange(GEO, desc(REF_DATE)) %>%
  select(REF_DATE, GEO, Estimate,
         `North American Industry Classification System (NAICS)`,
         VALUE, 
         MOM_val, MOM_pct, MOM_chg,
         YOY_val, YOY_pct, YOY_chg) %>%
  filter(REF_DATE >= "2008-01-01")


data_14_10_0223_01 %>%
  filter(GEO %in% c("British Columbia", "Canada"), 
         `North American Industry Classification System (NAICS)` == "Industrial aggregate excluding unclassified businesses", 
         Estimate == "Average weekly earnings including overtime for all employees") %>%
  group_by(GEO) %>%
  mutate(MOM_val = lag(VALUE),
         MOM_pct = ((VALUE / lag(VALUE, n = 1)) - 1) * 100,
         MOM_chg = (VALUE - lag(VALUE, n = 1)) ) %>%
  mutate(YOY_val = lag(VALUE, n = 12),
         YOY_pct = ((VALUE / lag(VALUE, n = 12)) - 1) * 100,
         YOY_chg = (VALUE - lag(VALUE, n = 12)) ) %>%
  arrange(GEO, desc(REF_DATE)) %>%
  select(REF_DATE, GEO, Estimate,
         `North American Industry Classification System (NAICS)`,
         VALUE, 
         MOM_val, MOM_pct, MOM_chg,
         YOY_val, YOY_pct, YOY_chg) %>%
  filter(REF_DATE >= "2008-01-01")

```



```{r}

dataplot <- data_14_10_0223_01 %>%
  filter(GEO %in% c("British Columbia", "Canada"), 
         `North American Industry Classification System (NAICS)` == "Industrial aggregate excluding unclassified businesses", 
         Estimate == "Average weekly earnings including overtime for all employees") %>%
  filter(REF_DATE >= as.Date("2008-01-01")) %>%
  ggplot(aes(x=REF_DATE, y=VALUE, group = GEO, colour = GEO)) + 
    geom_line(size=1.5) +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y",
               minor_breaks = NULL)
  
dataplot

```




```{r}

dataplot2 <- dataplot +
  ylim(700, 1050) +
  scale_y_continuous(labels = comma, limits = c(700, 1050)) +
  scale_colour_manual(name=NULL,
                      breaks=c("Canada", "British Columbia"),
                      labels=c("Canada", "British Columbia"), 
                      values=c("#325A80", "#CCB550")) +
  theme_bw() +
  theme(
    panel.border = element_rect(colour="white"),
    plot.title = element_text(face="bold"),
    legend.position=c(1,0), 
    legend.justification=c(1,0),
    legend.title = element_text(size=12),
    legend.text = element_text(size=11),
    axis.line = element_line(colour="black"),
    axis.title = element_text(size=10),
    axis.text = element_text(size=10)
  )
#
dataplot2 

# experiments with ggplot2's new subtitle and caption options

EI_title <- as.character("Average weekly earnings including overtime for all employees")
#EI_subtitle <- as.character("January 2010 = 100")
EI_caption <- as.character("Source: Statistics Canada, CANSIM table 14-10-0223-01")
EI_yaxis <- as.character("Dollars")

# add titles / X-Y axis labels / caption
EI_plot <- dataplot2 +
  labs(title = EI_title,
#       subtitle = EI_subtitle,
       caption = EI_caption, 
       x = NULL, y = EI_yaxis) 

EI_plot

ggsave(filename = "EI_plot.png", plot = EI_plot,
       width = 8, height = 6)

```


-30-